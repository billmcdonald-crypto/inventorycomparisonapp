<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Inventory Comparison</title>

  <style>
    body { font-family: system-ui; padding: 16px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 6px; }
    th { background: #f3f3f3; vertical-align: middle; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 14px; align-items: center; }
    input, select, button { padding: 6px; }
    .num { text-align: center; white-space: nowrap; }
    .mode { display: flex; align-items: center; gap: 6px; }
    .sort-ind { font-size: 11px; opacity: 0.7; }
    .filter-row th { background: #fafafa; }
    .filter-input { width: 100%; box-sizing: border-box; padding: 5px; }
    .muted { color: #666; font-size: 12px; }

    th.col-sku, td.col-sku {
      white-space: nowrap;
      min-width: 160px;
    }

    .th-stack { line-height: 1.05; text-align: center; white-space: nowrap; }
    .th-stack .l1 { font-weight: 700; }
    .th-stack .l2, .th-stack .l3 { font-weight: 600; font-size: 12px; opacity: 0.9; }

    thead th { position: sticky; top: 0; z-index: 3; background: #f3f3f3; }
    .filter-row th { position: sticky; top: 38px; z-index: 2; background: #fafafa; }

    .filter-input.active-filter { outline: 2px solid #2563eb; background: #eff6ff; }
    th.has-filter { background: #fff7ed !important; }
  </style>
</head>

<body>

<h2>Inventory Comparison</h2>

<div class="row">
  <select id="snapshots"></select>

  <select id="brandSelect">
    <option value="__ALL__">All Brands</option>
  </select>

  <label class="mode">
    <input type="radio" name="compareMode" value="onHand" checked />
    On Hand
  </label>

  <label class="mode">
    <input type="radio" name="compareMode" value="available" />
    Available to Sell
  </label>

  <label class="mode">
    <input type="checkbox" id="onlyDiff" />
    Only show differences
  </label>

  <button id="clearFilters">Clear Filters</button>
  <button id="exportCsv">Export CSV</button>
  <button id="exportXlsx">Export Excel</button>
</div>

<div id="meta" class="muted"></div>

<div style="overflow:auto; max-height: 70vh;">
  <table>
    <thead id="thead"></thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script>
const API_BASE = "/api";

let page = 1;
const pageSize = 100;
let sortField = "";
let sortDir = "desc";
let dynamicInvKeys = [];
let visibleColumns = [];
const filters = { brand: "", season: "", style: "", sku: "" };
let selectedBrand = "__ALL__";
const brandCache = {};

function getCompareMode() {
  const el = document.querySelector('input[name="compareMode"]:checked');
  return el ? el.value : "onHand";
}

function getDiffKeyForMode(mode) {
  return mode === "available" ? "Diff_ATS" : "Diff_OH";
}

function escapeHtml(s) {
  return String(s ?? "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;");
}

function normalizeRow(r) {
  const inv0 = (r?.Inventory?.length) ? r.Inventory[0] : {};
  return {
    brand: r.Brand || "",
    season: r.Season || "",
    style: r.Style || "",
    sku: r.SKU || "",
    inv: inv0 || {}
  };
}

async function loadSnapshots() {
  const res = await fetch(`${API_BASE}/snapshots`);
  const data = await res.json();
  const sel = document.getElementById("snapshots");
  sel.innerHTML = "";
  data.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.snapshotId;
    opt.textContent = `${new Date(s.snapshotDate).toLocaleDateString()} (${s.rowCount})`;
    sel.appendChild(opt);
  });
}

async function loadRows() {
  const snapshotId = document.getElementById("snapshots").value;
  if (!snapshotId) return;

  const mode = getCompareMode();
  const diffKey = getDiffKeyForMode(mode);
  const onlyDiff = document.getElementById("onlyDiff").checked ? "1" : "0";

  const qs = new URLSearchParams({
    page,
    pageSize,
    brand: filters.brand,
    season: filters.season,
    style: filters.style,
    sku: filters.sku,
    compareMode: mode,
    sort: `${sortField}_${sortDir}`,
    onlyDiff
  });

  qs.set("format","new");

  const res = await fetch(`${API_BASE}/snapshots/${snapshotId}/rows?` + qs.toString());
  const data = await res.json();

  const rows = (data.rows || []).map(normalizeRow);

  const tbody = document.getElementById("rows");
  tbody.innerHTML = "";

  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(r.brand)}</td>
      <td>${escapeHtml(r.season)}</td>
      <td>${escapeHtml(r.style)}</td>
      <td class="col-sku">${escapeHtml(r.sku)}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("meta").textContent =
    `Total rows: ${data.total} | Mode: ${mode}`;
}

function buildExportQueryParams(fileType) {
  const snapshotId = document.getElementById("snapshots").value;
  const onlyDiff = document.getElementById("onlyDiff").checked ? "1" : "0";

  const qs = new URLSearchParams({
    snapshotId,
    brand: filters.brand,
    season: filters.season,
    style: filters.style,
    sku: filters.sku,
    compareMode: getCompareMode(),
    sort: `${sortField}_${sortDir}`,
    onlyDiff
  });

  qs.set("format","new");
  qs.set("file", fileType);

  if (selectedBrand !== "__ALL__") {
    qs.set("brandView", selectedBrand);
  }

  return qs;
}

async function exportFile(fileType) {
  const qs = buildExportQueryParams(fileType);

  const res = await fetch(`${API_BASE}/export?` + qs.toString());
  if (!res.ok) {
    alert("Export failed");
    return;
  }

  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `inventory-export-${getCompareMode()}.${fileType}`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

document.getElementById("exportCsv").addEventListener("click", () => exportFile("csv"));
document.getElementById("exportXlsx").addEventListener("click", () => exportFile("xlsx"));

document.getElementById("snapshots").addEventListener("change", loadRows);
document.getElementById("onlyDiff").addEventListener("change", loadRows);
document.querySelectorAll('input[name="compareMode"]').forEach(r =>
  r.addEventListener("change", loadRows)
);

(async () => {
  await loadSnapshots();
  await loadRows();
})();
</script>

</body>
</html>