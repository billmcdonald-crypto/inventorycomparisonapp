<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Inventory Comparison</title>

<style>
body { font-family: system-ui; padding: 16px; }
table { border-collapse: collapse; width: 100%; }
th, td { border: 1px solid #ddd; padding: 6px; }
th { background: #f3f3f3; vertical-align: middle; }
.row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 14px; align-items: center; }
input, select, button { padding: 6px; }
.num { text-align: center; white-space: nowrap; }
.mode { display: flex; align-items: center; gap: 6px; }
.th-btn { cursor: pointer; user-select: none; display: inline-flex; gap: 6px; align-items: center; white-space: nowrap; }
.sort-ind { font-size: 11px; opacity: 0.7; }
.filter-row th { background: #fafafa; }
.filter-input { width: 100%; box-sizing: border-box; padding: 5px; }
.muted { color: #666; font-size: 12px; }

/* SKU no wrap */
th.col-sku, td.col-sku {
  white-space: nowrap;
  min-width: 160px;
}

/* Sticky header */
thead th {
  position: sticky;
  top: 0;
  z-index: 3;
  background: #f3f3f3;
}
.filter-row th {
  position: sticky;
  top: 38px;
  z-index: 2;
  background: #fafafa;
}

/* Filter highlight */
.filter-input.active-filter {
  outline: 2px solid #2563eb;
  background: #eff6ff;
}

th.has-filter {
  background: #fff7ed !important;
}

.filter-badge {
  margin-left: 6px;
  font-size: 12px;
}
</style>
</head>

<body>

<h2>Inventory Comparison</h2>

<div class="row">
<select id="snapshots"></select>

<label class="mode">
  <input type="radio" name="compareMode" value="onHand" checked />
  On Hand
</label>

<label class="mode">
  <input type="radio" name="compareMode" value="available" />
  Available to Sell
</label>

<label class="mode">
  <input type="checkbox" id="onlyDiff" />
  Only show differences
</label>

<button id="clearFilters">Clear Filters</button>
<button id="export">Export CSV</button>
<span id="exportStatus"></span>
</div>

<div id="meta" class="muted"></div>

<div style="overflow:auto; max-height: 70vh;">
<table>
<thead id="thead"></thead>
<tbody id="rows"></tbody>
</table>
</div>

<script>
const API_BASE = "/api";

let page = 1;
const pageSize = 100;

let sortField = "";
let sortDir = "desc";

let dynamicInvKeys = [];
let visibleColumns = [];

const filters = {
  brand: "",
  season: "",
  style: "",
  sku: ""
};

function debounce(fn, ms) {
  let t;
  return function() {
    clearTimeout(t);
    t = setTimeout(fn, ms);
  };
}

function getCompareMode() {
  const el = document.querySelector('input[name="compareMode"]:checked');
  return el ? el.value : "onHand";
}

function getDiffKeyForMode(mode) {
  return mode === "available" ? "Diff_ATS" : "Diff_OH";
}

function escapeHtml(s) {
  return String(s ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}

function normalizeRow(r) {
  const inv0 = (r.Inventory && r.Inventory.length) ? r.Inventory[0] : {};
  return {
    brand: r.Brand || "",
    season: r.Season || "",
    style: r.Style || "",
    sku: r.SKU || "",
    inv: inv0
  };
}

function buildColumnsFromRows(rows) {
  const mode = getCompareMode();
  const diffKey = getDiffKeyForMode(mode);

  const keySet = {};
  rows.forEach(r => {
    Object.keys(r.inv || {}).forEach(k => keySet[k] = true);
  });

  function matchesMode(k) {
    if (k === "Diff_OH" || k === "Diff_ATS") return k === diffKey;
    if (mode === "available") return k.includes("ATS");
    return k.includes("On Hand");
  }

  const invKeys = Object.keys(keySet).filter(matchesMode).sort();

  visibleColumns = [
    { key:"brand", label:"Brand" },
    { key:"season", label:"Season" },
    { key:"style", label:"Style" },
    { key:"sku", label:"SKU" }
  ];

  invKeys.forEach(k => visibleColumns.push({ key:k, label:k }));
  dynamicInvKeys = invKeys;
}

function renderHeader() {
  const thead = document.getElementById("thead");
  thead.innerHTML = "";

  const tr1 = document.createElement("tr");

  visibleColumns.forEach(col => {
    const th = document.createElement("th");
    if (col.key === "sku") th.classList.add("col-sku");

    const isBase = ["brand","season","style","sku"].includes(col.key);
    if (isBase) th.id = "th-" + col.key;

    let isFiltered = false;
    if (col.key in filters)
      isFiltered = filters[col.key].trim().length > 0;

    if (isFiltered) th.classList.add("has-filter");

    const badge = isFiltered ? `<span class="filter-badge">ðŸ”Ž</span>` : "";

    th.innerHTML = `
      <span class="th-btn">
        ${escapeHtml(col.label)}${badge}
      </span>
    `;

    tr1.appendChild(th);
  });

  thead.appendChild(tr1);

  const tr2 = document.createElement("tr");
  tr2.className = "filter-row";

  visibleColumns.forEach(col => {
    const th = document.createElement("th");

    if (col.key in filters) {
      th.innerHTML = `
        <input id="f-${col.key}"
               autocomplete="off"
               class="filter-input"
               placeholder="Filter..."
               value="${escapeHtml(filters[col.key])}" />
      `;
    }

    tr2.appendChild(th);
  });

  thead.appendChild(tr2);

  Object.keys(filters).forEach(k => {
    const el = document.getElementById("f-" + k);
    if (el) {
      el.addEventListener("input", debounce(() => {
        filters[k] = el.value;
        page = 1;
        loadRows();
      }, 250));
    }
  });

  applyFilterStyling();
}

function applyFilterStyling() {
  Object.keys(filters).forEach(k => {
    const input = document.getElementById("f-" + k);
    const th = document.getElementById("th-" + k);

    const active = filters[k].trim().length > 0;

    if (input) {
      input.classList.toggle("active-filter", active);
    }
    if (th) {
      th.classList.toggle("has-filter", active);
    }
  });
}

function clearAllFilters() {
  Object.keys(filters).forEach(k => filters[k] = "");
  page = 1;
  loadRows();
}

async function loadSnapshots() {
  const res = await fetch(`${API_BASE}/snapshots`);
  const data = await res.json();
  const sel = document.getElementById("snapshots");
  sel.innerHTML = "";

  data.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.snapshotId;
    opt.textContent = new Date(s.snapshotDate).toLocaleDateString();
    sel.appendChild(opt);
  });
}

async function loadRows() {
  const snapshotId = document.getElementById("snapshots").value;
  if (!snapshotId) return;

  const qs = new URLSearchParams({
    page,
    pageSize,
    ...filters,
    compareMode: getCompareMode()
  });

  const res = await fetch(`${API_BASE}/snapshots/${snapshotId}/rows?` + qs.toString());
  const data = await res.json();

  let rows = (data.rows || []).map(normalizeRow);

  buildColumnsFromRows(rows);
  renderHeader();

  const tbody = document.getElementById("rows");
  tbody.innerHTML = "";

  rows.forEach(r => {
    const tr = document.createElement("tr");

    visibleColumns.forEach(col => {
      const td = document.createElement("td");
      if (col.key === "sku") td.classList.add("col-sku");

      if (col.key in r) td.textContent = r[col.key];
      else td.textContent = r.inv[col.key] ?? "";

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

async function exportCsv() {
  const snapshotId = document.getElementById("snapshots").value;
  if (!snapshotId) return;

  const qs = new URLSearchParams({
    snapshotId,
    ...filters,
    compareMode: getCompareMode()
  });

  const res = await fetch(`${API_BASE}/export?` + qs.toString());
  const blob = await res.blob();

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "inventory-export.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

document.getElementById("clearFilters").addEventListener("click", clearAllFilters);
document.getElementById("export").addEventListener("click", exportCsv);
document.getElementById("snapshots").addEventListener("change", () => loadRows());
document.querySelectorAll('input[name="compareMode"]').forEach(r => {
  r.addEventListener("change", () => loadRows());
});

(async () => {
  await loadSnapshots();
  await loadRows();
})();
</script>

</body>
</html>