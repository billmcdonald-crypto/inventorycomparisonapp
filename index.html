<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Inventory Comparison</title>

  <style>
    body { font-family: system-ui; padding: 16px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 6px; }
    th { background: #f3f3f3; vertical-align: middle; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 14px; align-items: center; }
    input, select, button { padding: 6px; }
    .num { text-align: center; }
    .mode { display: flex; align-items: center; gap: 6px; }
    .th-btn {
      cursor: pointer;
      user-select: none;
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }
    .sort-ind { font-size: 11px; opacity: 0.7; }
    .filter-row th { background: #fafafa; }
    .filter-input {
      width: 100%;
      box-sizing: border-box;
      padding: 5px;
    }
    .muted { color: #666; font-size: 12px; }
  </style>
</head>

<body>

<h2>Inventory Comparison</h2>

<div class="row">
  <select id="snapshots"></select>

  <label class="mode">
    <input type="radio" name="compareMode" value="onHand" checked />
    On Hand
  </label>

  <label class="mode">
    <input type="radio" name="compareMode" value="available" />
    Available to Sell
  </label>

  <label class="mode">
    <input type="checkbox" id="onlyDiff" />
    Only show differences
  </label>

  <button id="refresh">Refresh</button>
  <button id="clearFilters">Clear Filters</button>
  <button id="export">Export CSV</button>
  <span id="exportStatus"></span>
</div>

<div id="meta" class="muted"></div>

<table>
  <thead>
    <tr>
      <th><span class="th-btn" data-sort="brand">Brand <span id="si-brand" class="sort-ind"></span></span></th>
      <th><span class="th-btn" data-sort="item">Item <span id="si-item" class="sort-ind"></span></span></th>
      <th><span class="th-btn" data-sort="item_name">Item Name <span id="si-item_name" class="sort-ind"></span></span></th>
      <th><span class="th-btn" data-sort="item_class">Class <span id="si-item_class" class="sort-ind"></span></span></th>
      <th><span class="th-btn" data-sort="netsuite">NetSuite <span id="si-netsuite" class="sort-ind"></span></span></th>
      <th><span class="th-btn" data-sort="snap">Snap <span id="si-snap" class="sort-ind"></span></span></th>
      <th><span class="th-btn" data-sort="difference">Diff <span id="si-difference" class="sort-ind"></span></span></th>
    </tr>

    <tr class="filter-row">
      <th><input id="fBrand" class="filter-input" placeholder="Filter brand…" /></th>
      <th><input id="fItem" class="filter-input" placeholder="Filter item/name…" /></th>
      <th></th>
      <th><input id="fClass" class="filter-input" placeholder="Filter class…" /></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>

  <tbody id="rows"></tbody>
</table>

<script>
const API_BASE = "/api";

let page = 1;
const pageSize = 100;

let sortField = "difference";
let sortDir = "desc";

function debounce(fn, ms) {
  let t;
  return function() {
    clearTimeout(t);
    t = setTimeout(() => fn(), ms);
  };
}

function getCompareMode() {
  const el = document.querySelector('input[name="compareMode"]:checked');
  return el ? el.value : "onHand";
}

function updateSortIndicators() {
  const ids = ["brand","item","item_name","item_class","netsuite","snap","difference"];
  ids.forEach(id => {
    const el = document.getElementById("si-" + id);
    if (!el) return;
    el.textContent = (sortField === id) ? (sortDir === "asc" ? "▲" : "▼") : "";
  });
}

function setSort(field) {
  if (sortField === field) {
    sortDir = sortDir === "asc" ? "desc" : "asc";
  } else {
    sortField = field;
    sortDir = "desc";
  }
  page = 1;
  updateSortIndicators();
  loadRows();
}

function clearAllFilters() {
  document.getElementById("fBrand").value = "";
  document.getElementById("fItem").value = "";
  document.getElementById("fClass").value = "";
  page = 1;
  loadRows();
}

async function loadSnapshots() {
  const res = await fetch(`${API_BASE}/snapshots`);
  const data = await res.json();
  const sel = document.getElementById("snapshots");
  sel.innerHTML = "";

  if (data && data.length) {
    data.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.snapshotId;
      opt.textContent = `${new Date(s.snapshotDate).toLocaleDateString()} (${s.rowCount})`;
      sel.appendChild(opt);
    });
  } else {
    const opt = document.createElement("option");
    opt.textContent = "No snapshots found";
    sel.appendChild(opt);
  }
}

async function loadRows() {
  const snapshotId = document.getElementById("snapshots").value;
  if (!snapshotId) return;

  const brand = document.getElementById("fBrand").value || "";
  const itemClass = document.getElementById("fClass").value || "";
  const search = document.getElementById("fItem").value || "";
  const onlyDiff = document.getElementById("onlyDiff").checked ? "1" : "0";

  const qs = new URLSearchParams({
    page,
    pageSize,
    brand,
    itemClass,
    search,
    compareMode: getCompareMode(),
    sort: `${sortField}_${sortDir}`,
    onlyDiff
  });

  const res = await fetch(`${API_BASE}/snapshots/${snapshotId}/rows?` + qs.toString());
  const data = await res.json();

  document.getElementById("meta").textContent =
    `Total rows: ${data.total} | Sort: ${sortField}_${sortDir} | Mode: ${getCompareMode()}`;

  const tbody = document.getElementById("rows");
  tbody.innerHTML = "";

  (data.rows || []).forEach(r => {
    const diff = r.difference ?? 0;
    const diffColor = diff === 0 ? "#15803d" : (diff > 0 ? "#b45309" : "#b91c1c");

    const tr = document.createElement("tr");
    tr.innerHTML =
      `<td>${r.brand || ""}</td>` +
      `<td>${r.item || ""}</td>` +
      `<td>${r.item_name || ""}</td>` +
      `<td>${r.item_class || ""}</td>` +
      `<td class="num">${r.netsuite_total ?? ""}</td>` +
      `<td class="num">${r.snap_total ?? ""}</td>` +
      `<td class="num" style="font-weight:700;color:${diffColor};">${diff}</td>`;
    tbody.appendChild(tr);
  });
}

async function exportCsv() {
  const snapshotId = document.getElementById("snapshots").value;
  if (!snapshotId) return;

  const brand = document.getElementById("fBrand").value || "";
  const itemClass = document.getElementById("fClass").value || "";
  const search = document.getElementById("fItem").value || "";
  const onlyDiff = document.getElementById("onlyDiff").checked ? "1" : "0";

  const qs = new URLSearchParams({
    snapshotId,
    brand,
    itemClass,
    search,
    compareMode: getCompareMode(),
    sort: `${sortField}_${sortDir}`,
    onlyDiff
  });

  const res = await fetch(`${API_BASE}/export?` + qs.toString());
  const blob = await res.blob();

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `inventory-export-${getCompareMode()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

document.getElementById("refresh").addEventListener("click", () => { page = 1; loadRows(); });
document.getElementById("clearFilters").addEventListener("click", clearAllFilters);
document.getElementById("export").addEventListener("click", exportCsv);
document.getElementById("snapshots").addEventListener("change", () => { page = 1; loadRows(); });
document.getElementById("onlyDiff").addEventListener("change", () => { page = 1; loadRows(); });

document.querySelectorAll('input[name="compareMode"]').forEach(r => {
  r.addEventListener("change", () => { page = 1; loadRows(); });
});

document.querySelectorAll(".th-btn").forEach(el => {
  el.addEventListener("click", () => setSort(el.getAttribute("data-sort")));
});

const onFilterChange = debounce(() => { page = 1; loadRows(); }, 250);
["fBrand", "fItem", "fClass"].forEach(id => {
  document.getElementById(id).addEventListener("input", onFilterChange);
});

(async () => {
  await loadSnapshots();
  updateSortIndicators();
  await loadRows();
})();
</script>

</body>
</html>