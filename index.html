<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Inventory Comparison</title>

  <style>
    body { font-family: system-ui; padding: 16px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 6px; }
    th { background: #f3f3f3; vertical-align: middle; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 14px; align-items: center; }
    input, select, button { padding: 6px; }
    .num { text-align: center; white-space: nowrap; }
    .mode { display: flex; align-items: center; gap: 6px; }
    .th-btn {
      cursor: pointer;
      user-select: none;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      white-space: nowrap;
    }
    .sort-ind { font-size: 11px; opacity: 0.7; }
    .filter-row th { background: #fafafa; }
    .filter-input { width: 100%; box-sizing: border-box; padding: 5px; }
    .muted { color: #666; font-size: 12px; }

    th.col-sku, td.col-sku {
      white-space: nowrap;
      word-break: normal;
      overflow-wrap: normal;
      min-width: 160px;
    }

    .th-stack { line-height: 1.05; text-align: center; white-space: nowrap; }
    .th-stack .l1 { font-weight: 700; }
    .th-stack .l2 { font-weight: 600; font-size: 12px; opacity: 0.9; }
    .th-stack .l3 { font-weight: 600; font-size: 12px; opacity: 0.9; }

    thead th { position: sticky; top: 0; z-index: 3; background: #f3f3f3; }
    .filter-row th { position: sticky; top: 38px; z-index: 2; background: #fafafa; }

    .filter-input.active-filter { outline: 2px solid #2563eb; background: #eff6ff; }
    th.has-filter { background: #fff7ed !important; }
    .filter-badge { margin-left: 6px; font-size: 12px; opacity: 0.85; }

    .authbar { display:flex; gap:12px; align-items:center; margin: 6px 0 14px; }
    .authbar a { font-size: 13px; }
    .pill { font-size: 12px; padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; background: #fafafa; }
  </style>
</head>

<body>

<h2>Inventory Comparison</h2>

<!-- COMMENTING out
  <div class="authbar"> 
 <a href="/.auth/login/aad">Sign in</a>
 <a href="/.auth/login/aad?login_hint=admin@ngac-newtimesgroup.com&prompt=login">Admin sign in</a>
</div> -->

 

<div class="row">
  <select id="snapshots"></select>

  <select id="brandSelect">
    <option value="__ALL__">All Brands</option>
  </select>

  <label class="mode">
    <input type="radio" name="compareMode" value="onHand" checked />
    On Hand
  </label>

  <label class="mode">
    <input type="radio" name="compareMode" value="available" />
    Available to Sell
  </label>

  <label class="mode" id="onlyDiffWrap">
    <input type="checkbox" id="onlyDiff" />
    Only show differences
  </label>

  <button id="clearFilters">Clear Filters</button>

  <button id="exportCsv">Export CSV</button>
  <button id="exportXlsx">Export Excel</button>

  <span id="exportStatus"></span>
</div>

<div id="meta" class="muted"></div>

<div style="overflow:auto; max-height: 70vh;">
  <table>
    <thead id="thead"></thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script>
const API_BASE = "/api";

let page = 1;
const pageSize = 250;

let sortField = "";
let sortDir = "desc";

let dynamicInvKeys = [];
let visibleColumns = [];

const filters = { brand: "", season: "", style: "", sku: "" };
let justCleared = false;

// Brand dropdown state
let selectedBrand = "__ALL__";
const brandCache = {};

// ===== Auth/Role-derived view controls =====
let AUTH_ROLES = [];
let IS_INTERNAL = false;
let BRAND_LOCK = "";      // e.g. "Robert Talbott" | "Ashworth" | "Bike" | "NPG" | ""
let SHOW_SNAP = true;     // internal only
let SHOW_DIFF = true;     // internal only

const ROLE_TO_BRAND = {
  "rt": "Robert Talbott",
  "ashworth": "Ashworth",
  "bike": "Bike",
  "npg": "NPG"
};

async function loadAuthContext() {
  try {
    const res = await fetch("/.auth/me", { cache: "no-store" });
    if (!res.ok) return;
    const data = await res.json();

    // SWA returns an array; first entry has clientPrincipal
    const cp = (data && data.clientPrincipal) ? data.clientPrincipal
              : (Array.isArray(data) && data[0] && data[0].clientPrincipal ? data[0].clientPrincipal : null);
    if (!cp) return;

    const roles = (cp.userRoles || []).map(r => String(r || "").toLowerCase());
    AUTH_ROLES = roles;

    IS_INTERNAL = roles.indexOf("internal") >= 0;
    SHOW_SNAP = IS_INTERNAL;
    SHOW_DIFF = IS_INTERNAL;

    BRAND_LOCK = "";
    for (const role in ROLE_TO_BRAND) {
      if (roles.indexOf(role) >= 0) { BRAND_LOCK = ROLE_TO_BRAND[role]; break; }
    }

    // Update auth pill
    const info = document.getElementById("authInfo");
    if (info) {
      info.style.display = "";
      const u = cp.userDetails || "";
      const roleLabel = IS_INTERNAL ? "internal" : (BRAND_LOCK ? ("brand:" + BRAND_LOCK) : "no-role");
      info.textContent = u ? (u + " â€¢ " + roleLabel) : roleLabel;
    }

    // If not internal, hide Only Diff toggle (diff data should not be shown)
    if (!SHOW_DIFF) {
      const wrap = document.getElementById("onlyDiffWrap");
      if (wrap) wrap.style.display = "none";
      const cb = document.getElementById("onlyDiff");
      if (cb) cb.checked = false;
    }

    // If brand-locked, force it and hide dropdown
    if (BRAND_LOCK) {
      selectedBrand = BRAND_LOCK;
      const sel = document.getElementById("brandSelect");
      if (sel) sel.style.display = "none";
    }

  } catch (e) {
    // If /.auth/me fails (not logged in yet), run in anonymous mode.
  }
}

function debounce(fn, ms) {
  let t;
  return function() {
    clearTimeout(t);
    const args = arguments;
    t = setTimeout(() => fn.apply(null, args), ms);
  };
}

function normStr(s) {
  return String(s == null ? "" : s).trim().toLowerCase();
}

function getCompareMode() {
  const el = document.querySelector('input[name="compareMode"]:checked');
  return el ? el.value : "onHand";
}

function getDiffKeyForMode(mode) {
  return mode === "available" ? "Diff_ATS" : "Diff_OH";
}

function normalizeRow(r) {
  const inv0 = (r && r.Inventory && r.Inventory.length) ? r.Inventory[0]
              : (r && r.inventory && r.inventory.length ? r.inventory[0] : {});
  return {
    brand: r.Brand || r.brand || "",
    season: r.Season || r.season || "",
    style: r.Style || r.style || "",
    title: r.Title || r.title || r.ItemName || r.item_name || "",
    sku: r.SKU || r.sku || "",
    inv: inv0 || {}
  };
}

function escapeHtml(s) {
  return String(s == null ? "" : s)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}

function toNumberOrNull(v) {
  if (v === null || v === undefined || v === "") return null;
  const n = Number(v);
  return isNaN(n) ? null : n;
}

function getStackedHeaderParts(label, mode) {
  const s = String(label || "");
  const metric = (mode === "available") ? "ATS" : "On Hand";

  if (s === "Diff_OH" || s === "Diff_ATS") {
    return { l1: "Diff", l2: "", l3: (mode === "available") ? "ATS" : "On-Hand" };
  }

  const metricPos = s.indexOf(metric);
  if (metricPos >= 0) {
    const left = s.substring(0, metricPos).trim();
    const right = s.substring(metricPos).trim();
    const leftParts = left.split(/\s+/);
    return {
      l1: leftParts[0] || s,
      l2: leftParts.slice(1).join(" ") || "",
      l3: right.replace("On Hand", "On-Hand")
    };
  }

  return { l1: s, l2: "", l3: "" };
}

function renderHeaderLabel(colLabel, mode) {
  if (colLabel === "Brand" || colLabel === "Season" || colLabel === "Style" || colLabel === "SKU") {
    return escapeHtml(colLabel);
  }

  const p = getStackedHeaderParts(colLabel, mode);
  return (
    '<div class="th-stack">' +
      '<div class="l1">' + escapeHtml(p.l1) + '</div>' +
      (p.l2 ? '<div class="l2">' + escapeHtml(p.l2) + '</div>' : '<div class="l2"></div>') +
      (p.l3 ? '<div class="l3">' + escapeHtml(p.l3) + '</div>' : '<div class="l3"></div>') +
    '</div>'
  );
}

function updateBrandCacheFromRows(rowsNormalized) {
  rowsNormalized.forEach(r => {
    const b = String(r.brand || "").trim();
    if (!b) return;
    brandCache[b] = true;
  });
}

function renderBrandDropdown() {
  const sel = document.getElementById("brandSelect");
  if (!sel) return;

  // Brand-locked users don't see dropdown
  if (BRAND_LOCK) {
    sel.style.display = "none";
    selectedBrand = BRAND_LOCK;
    return;
  } else {
    sel.style.display = "";
  }

  const current = selectedBrand;

  sel.innerHTML = "";
  const optAll = document.createElement("option");
  optAll.value = "__ALL__";
  optAll.textContent = "All Brands";
  sel.appendChild(optAll);

  const brands = Object.keys(brandCache).sort(function(a,b){ return a.localeCompare(b); });
  brands.forEach(b => {
    const o = document.createElement("option");
    o.value = b;
    o.textContent = b;
    sel.appendChild(o);
  });

  sel.value = current;
  if (sel.value !== current) {
    selectedBrand = "__ALL__";
    sel.value = "__ALL__";
  }
}

function rowMatchesSelectedBrand(r) {
  if (BRAND_LOCK) return normStr(r.brand) === normStr(BRAND_LOCK);
  if (!selectedBrand || selectedBrand === "__ALL__") return true;
  return normStr(r.brand) === normStr(selectedBrand);
}

// Central rule: which inventory keys are allowed to show in the UI
function keyAllowed(k) {
  const kk = String(k || "");

  // Hide Snap/Diff for brand users
  if (!SHOW_SNAP && kk.indexOf("Snap ") === 0) return false;
  if (!SHOW_DIFF && (kk === "Diff_OH" || kk === "Diff_ATS")) return false;

  // Brand locked: only allow that brand's prefixed columns + NetSuite totals
  if (BRAND_LOCK) {
    const prefix = String(BRAND_LOCK).trim() + " ";
    if (kk.indexOf(prefix) === 0) return true;
    if (kk.indexOf("NetSuite Total") === 0) return true;
    return false;
  }

  // Not locked: allow all keys (subject to Snap/Diff flags above)
  return true;
}

function buildColumnsFromRows(rowsNormalized) {
  const mode = getCompareMode();
  const diffKey = getDiffKeyForMode(mode);

  const keySet = {};
  rowsNormalized.forEach(r => {
    const inv = r.inv || {};
    Object.keys(inv).forEach(k => { keySet[k] = true; });
  });

  function keyMatchesMode(k) {
    const kk = String(k || "");

    const isDiff = (kk === "Diff_OH" || kk === "Diff_ATS");
    if (isDiff) return kk === diffKey;

    const hasOnHand = kk.indexOf("On Hand") >= 0;
    const hasATS = kk.indexOf("ATS") >= 0;

    if (mode === "available") return hasATS;
    return hasOnHand;
  }

  const allKeys = Object.keys(keySet).filter(function(k){
    return keyMatchesMode(k) && keyAllowed(k);
  });

  // Preferred ordering, but only include what is allowed
  const preferredOrderOnHand = ["NetSuite Total On Hand","Snap Total On Hand","Diff_OH"];
  const preferredOrderATS = ["NetSuite Total ATS","Snap Total ATS","Diff_ATS"];
  const preferredOrder = (mode === "available") ? preferredOrderATS : preferredOrderOnHand;

  const preferred = [];
  preferredOrder.forEach(k => { if (allKeys.indexOf(k) >= 0) preferred.push(k); });

  const remaining = allKeys.filter(k => preferred.indexOf(k) === -1);
  remaining.sort(function(a,b){ return a.localeCompare(b); });

  dynamicInvKeys = preferred.concat(remaining);

  visibleColumns = [
    { key: "brand", label: "Brand", sortKey: "brand" },
    { key: "season", label: "Season", sortKey: "season" },
    { key: "style", label: "Style", sortKey: "style" },
    { key: "title", label: "Title", sortKey: "title" },
    { key: "sku", label: "SKU", sortKey: "sku", thClass: "col-sku" }
  ];

  dynamicInvKeys.forEach(k => {
    visibleColumns.push({ key: k, label: k, sortKey: k });
  });
}

function updateSortIndicators() {
  visibleColumns.forEach(col => {
    const el = document.getElementById("si-" + col.sortKey);
    if (!el) return;
    el.textContent = (sortField === col.sortKey) ? (sortDir === "asc" ? "â–²" : "â–¼") : "";
  });
}

function setSort(field) {
  if (sortField === field) sortDir = (sortDir === "asc") ? "desc" : "asc";
  else { sortField = field; sortDir = "desc"; }
  page = 1;
  updateSortIndicators();
  loadRows();
}

function applyFilterStyling() {
  const mapping = [
    { id: "fBrand", key: "brand", thKey: "brand" },
    { id: "fSeason", key: "season", thKey: "season" },
    { id: "fStyle", key: "style", thKey: "style" },
    { id: "fSku", key: "sku", thKey: "sku" }
  ];

  mapping.forEach(m => {
    const input = document.getElementById(m.id);
    const th = document.getElementById("th-" + m.thKey);
    const active = String(filters[m.key] || "").trim().length > 0;

    if (input) input.classList.toggle("active-filter", active);
    if (th) th.classList.toggle("has-filter", active);
  });
}

function clearAllFilters() {
  justCleared = true;
  setTimeout(() => { justCleared = false; }, 600);

  filters.brand = "";
  filters.season = "";
  filters.style = "";
  filters.sku = "";

  ["fBrand","fSeason","fStyle","fSku"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });

  applyFilterStyling();
  page = 1;
  loadRows();
}

function renderHeader() {
  const thead = document.getElementById("thead");
  thead.innerHTML = "";

  const mode = getCompareMode();
  const tr1 = document.createElement("tr");

  visibleColumns.forEach(col => {
    const th = document.createElement("th");
    if (col.thClass) th.className = col.thClass;

    const isBase = (col.key === "brand" || col.key === "season" || col.key === "style" || col.key === "sku");
    if (isBase) th.id = "th-" + col.key;

    let isFiltered = false;
    if (col.key === "brand") isFiltered = String(filters.brand || "").trim().length > 0;
    else if (col.key === "season") isFiltered = String(filters.season || "").trim().length > 0;
    else if (col.key === "style") isFiltered = String(filters.style || "").trim().length > 0;
    else if (col.key === "sku") isFiltered = String(filters.sku || "").trim().length > 0;

    const badge = (isBase && isFiltered) ? `<span class="filter-badge">ðŸ”Ž</span>` : "";

    th.innerHTML =
      `<span class="th-btn" data-sort="${escapeHtml(col.sortKey)}">` +
        `${renderHeaderLabel(col.label, mode)}${badge} ` +
        `<span id="si-${escapeHtml(col.sortKey)}" class="sort-ind"></span>` +
      `</span>`;

    tr1.appendChild(th);
  });

  thead.appendChild(tr1);

  const tr2 = document.createElement("tr");
  tr2.className = "filter-row";

  visibleColumns.forEach(col => {
    const th = document.createElement("th");
    if (col.thClass) th.className = col.thClass;

    if (col.key === "brand") th.innerHTML = `<input id="fBrand" name="fBrand" autocomplete="off" class="filter-input" placeholder="Filter brandâ€¦" />`;
    else if (col.key === "season") th.innerHTML = `<input id="fSeason" name="fSeason" autocomplete="off" class="filter-input" placeholder="Filter seasonâ€¦" />`;
    else if (col.key === "style") th.innerHTML = `<input id="fStyle" name="fStyle" autocomplete="off" class="filter-input" placeholder="Filter styleâ€¦" />`;
    else if (col.key === "sku") th.innerHTML = `<input id="fSku" name="fSku" autocomplete="off" class="filter-input" placeholder="Filter SKUâ€¦" />`;
    else th.innerHTML = "";

    tr2.appendChild(th);
  });

  thead.appendChild(tr2);

  thead.querySelectorAll(".th-btn").forEach(el => {
    el.addEventListener("click", () => setSort(el.getAttribute("data-sort")));
  });

  if (document.getElementById("fBrand")) document.getElementById("fBrand").value = filters.brand;
  if (document.getElementById("fSeason")) document.getElementById("fSeason").value = filters.season;
  if (document.getElementById("fStyle")) document.getElementById("fStyle").value = filters.style;
  if (document.getElementById("fSku")) document.getElementById("fSku").value = filters.sku;

  function syncFiltersFromInputs() {
    filters.brand = (document.getElementById("fBrand") && document.getElementById("fBrand").value) || "";
    filters.season = (document.getElementById("fSeason") && document.getElementById("fSeason").value) || "";
    filters.style = (document.getElementById("fStyle") && document.getElementById("fStyle").value) || "";
    filters.sku = (document.getElementById("fSku") && document.getElementById("fSku").value) || "";
  }

  ["fBrand","fSeason","fStyle","fSku"].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;

    el.addEventListener("input", () => {
      syncFiltersFromInputs();
      applyFilterStyling();
    });

    el.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        syncFiltersFromInputs();
        applyFilterStyling();
        page = 1;
        loadRows();
      }
      if (e.key === "Escape") {
        e.preventDefault();
        el.value = "";
        syncFiltersFromInputs();
        applyFilterStyling();
      }
    });
  });

  updateSortIndicators();
  applyFilterStyling();
}

async function loadSnapshots() {
  const res = await fetch(`${API_BASE}/snapshots`);
  const data = await res.json();
  const sel = document.getElementById("snapshots");
  sel.innerHTML = "";

  if (data && data.length) {
    data.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.snapshotId;
      opt.textContent = `${s.snapshotDate} (${s.rowCount})`;
      sel.appendChild(opt);
    });
  } else {
    const opt = document.createElement("option");
    opt.textContent = "No snapshots found";
    sel.appendChild(opt);
  }
}

async function loadRows() {
  const snapshotId = document.getElementById("snapshots").value;
  if (!snapshotId) return;

  const mode = getCompareMode();
  const diffKey = getDiffKeyForMode(mode);

  // If diff isn't allowed, avoid sorting by diff
  if (!SHOW_DIFF && (sortField === "Diff_OH" || sortField === "Diff_ATS")) {
    sortField = "";
  }

  if (!sortField || sortField === "Diff_OH" || sortField === "Diff_ATS") {
    sortField = SHOW_DIFF ? diffKey : "sku";
    sortDir = SHOW_DIFF ? "desc" : "asc";
  }

  const onlyDiff = (SHOW_DIFF && document.getElementById("onlyDiff").checked) ? "1" : "0";

const brandParam =
  BRAND_LOCK ? BRAND_LOCK :
  (filters.brand && filters.brand.trim() ? filters.brand.trim() :
   (selectedBrand !== "__ALL__" ? selectedBrand : ""));

const qs = new URLSearchParams({
  page,
  pageSize,
  brand: brandParam,          // âœ… dropdown (or typed filter) goes here
  season: filters.season,
  style: filters.style,
  sku: filters.sku,
  compareMode: mode,
  sort: `${sortField}_${sortDir}`,
  onlyDiff
});

qs.set("format", "new");
  

  const res = await fetch(`${API_BASE}/snapshots/${snapshotId}/rows?` + qs.toString());
  const data = await res.json();

  let rowsNormalized = (data.rows || []).map(normalizeRow);

  updateBrandCacheFromRows(rowsNormalized);
  renderBrandDropdown();

  if (BRAND_LOCK) {
    rowsNormalized = rowsNormalized.filter(rowMatchesSelectedBrand);
  }

  if (SHOW_DIFF && document.getElementById("onlyDiff").checked) {
    rowsNormalized = rowsNormalized.filter(r => {
      const v = (r.inv && r.inv[diffKey]) != null ? Number(r.inv[diffKey]) : 0;
      return v !== 0;
    });
  }

  buildColumnsFromRows(rowsNormalized);
  renderHeader();

  const brandLabel = BRAND_LOCK ? BRAND_LOCK : ((selectedBrand === "__ALL__") ? "All Brands" : selectedBrand);

  document.getElementById("meta").textContent =
    `Total rows: ${data.total} | Sort: ${sortField}_${sortDir} | Mode: ${mode} | Brand view: ${brandLabel}`;

  const tbody = document.getElementById("rows");
  tbody.innerHTML = "";

  rowsNormalized.forEach(r => {
    const inv = r.inv || {};
    const tr = document.createElement("tr");

    let html = "";
    html += `<td>${escapeHtml(r.brand)}</td>`;
    html += `<td>${escapeHtml(r.season)}</td>`;
    html += `<td>${escapeHtml(r.style)}</td>`;
    html += `<td>${escapeHtml(r.title)}</td>`;
    html += `<td class="col-sku">${escapeHtml(r.sku)}</td>`;

    dynamicInvKeys.forEach(k => {
      const v = inv[k];
      const isDiffCol = (k === "Diff_OH" || k === "Diff_ATS");
      const n = toNumberOrNull(v);

      if (isDiffCol) {
        // If diff isn't allowed, it won't be in dynamicInvKeys, but keep safe
        if (!SHOW_DIFF) return;
        const dv = (toNumberOrNull(v) ?? 0);
        const c = dv === 0 ? "#15803d" : (dv > 0 ? "#b45309" : "#b91c1c");
        html += `<td class="num" style="font-weight:700;color:${c};">${escapeHtml(dv)}</td>`;
      } else if (n !== null) {
        html += `<td class="num">${escapeHtml(n)}</td>`;
      } else {
        html += `<td>${escapeHtml(v)}</td>`;
      }
    });

    tr.innerHTML = html;
    tbody.appendChild(tr);
  });

  applyFilterStyling();
}

window.addEventListener("pageshow", () => {
  if (justCleared) return;

  const b = document.getElementById("fBrand");
  const s = document.getElementById("fSeason");
  const st = document.getElementById("fStyle");
  const k = document.getElementById("fSku");

  if (b || s || st || k) {
    filters.brand = (b && b.value) || filters.brand || "";
    filters.season = (s && s.value) || filters.season || "";
    filters.style = (st && st.value) || filters.style || "";
    filters.sku = (k && k.value) || filters.sku || "";
    applyFilterStyling();
  }
});

function buildExportQueryParams(fileType) {
  const snapshotId = document.getElementById("snapshots").value;
  const onlyDiff = (SHOW_DIFF && document.getElementById("onlyDiff").checked) ? "1" : "0";

  const qs = new URLSearchParams({
    snapshotId,
    brand: filters.brand,
    season: filters.season,
    style: filters.style,
    sku: filters.sku,
    compareMode: getCompareMode(),
    sort: `${sortField}_${sortDir}`,
    onlyDiff
  });

  qs.set("format", "new");
  qs.set("file", fileType);

  // brand selection drop down
  if (BRAND_LOCK) {
    qs.set("brandView", BRAND_LOCK);
  } else if (selectedBrand && selectedBrand !== "__ALL__") {
    qs.set("brandView", selectedBrand);
  }

  return qs;
}

async function exportFile(fileType) {
  const snapshotId = document.getElementById("snapshots").value;
  if (!snapshotId) return;

  const qs = buildExportQueryParams(fileType);

  const res = await fetch(`${API_BASE}/export?` + qs.toString());
  if (!res.ok) {
    const txt = await res.text();
    alert("Export failed: " + txt);
    return;
  }

  const blob = await res.blob();
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;

  const ext = (fileType === "xlsx") ? "xlsx" : "csv";
  a.download = `inventory-export-${getCompareMode()}.${ext}`;

  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

document.getElementById("clearFilters").addEventListener("click", clearAllFilters);
document.getElementById("exportCsv").addEventListener("click", () => exportFile("csv"));
document.getElementById("exportXlsx").addEventListener("click", () => exportFile("xlsx"));

document.getElementById("snapshots").addEventListener("change", () => { page = 1; loadRows(); });
document.getElementById("onlyDiff").addEventListener("change", () => { page = 1; loadRows(); });

document.getElementById("brandSelect").addEventListener("change", () => {
  selectedBrand = document.getElementById("brandSelect").value || "__ALL__";
  page = 1;
  loadRows();
});

document.querySelectorAll('input[name="compareMode"]').forEach(r => {
  r.addEventListener("change", () => { page = 1; loadRows(); });
});

(async () => {
  await loadAuthContext();
  await loadSnapshots();
  await loadRows();
})();
</script>

</body>
</html>