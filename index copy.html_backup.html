<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Inventory Comparison</title>
    <style>
      body { font-family: system-ui; padding: 16px; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #ddd; padding: 6px; }
      th { background: #f3f3f3; }
      .row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
      input, select, button { padding: 6px; }

      .num {
      text-align: center;
      }

    </style>
  </head>
  <body>
    <h2>Inventory Comparison</h2>

    <div class="row">
      <select id="snapshots"></select>
      <input id="brand" placeholder="Brand" />
      <input id="itemClass" placeholder="Item Class" />
      <input id="search" placeholder="Search item/name" />
      <button id="refresh">Refresh</button>
      <button id="export">Export (async)</button>
      <span id="exportStatus"></span>
    </div>

    <div id="meta"></div>
    <table>
      <thead>
        <tr>
          <th>Brand</th><th>Item</th><th>Item Name</th><th>Class</th>
          <th>NetSuite</th><th>Snap</th><th>Diff</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <script>
      // Function App base URL
      const API_BASE = "https://inventorycomparisonapp-asehfcc5fwbwa4cy.westus-01.azurewebsites.net/api";

      let page = 1;
      const pageSize = 100;
      let exportPoll = null;

      function formatDatePretty(isoDate) {
      if (!isoDate) return "";
      const d = new Date(isoDate);
      return d.toLocaleDateString("en-US", {
      month: "short",
      day: "2-digit",
     year: "numeric"
    });
    }

      async function loadSnapshots() {
        const res = await fetch(`${API_BASE}/snapshots`);
        const data = await res.json();
        const sel = document.getElementById("snapshots");
        sel.innerHTML = "";
        data.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.snapshotId;
          opt.textContent = `${formatDatePretty(s.snapshotDate)} (${s.rowCount})`;
          sel.appendChild(opt);
        });
      }

      async function loadRows() {
        const snapshotId = document.getElementById("snapshots").value;
        const brand = document.getElementById("brand").value || "";
        const itemClass = document.getElementById("itemClass").value || "";
        const search = document.getElementById("search").value || "";
        
        const qs = new URLSearchParams({
          page: String(page),
          pageSize: String(pageSize),
          brand,
          itemClass,
          search,
          sort: "difference_desc"
        });

        const res = await fetch(`${API_BASE}/snapshots/${snapshotId}/rows?` + qs.toString());
        const data = await res.json();

        document.getElementById("meta").textContent =
          `Total rows: ${data.total} | Page: ${data.page}`;

        const tbody = document.getElementById("rows");
        tbody.innerHTML = "";
        (data.rows || []).forEach(r => {
          const tr = document.createElement("tr");
          
        tr.innerHTML = `
          <td>${r.brand || ""}</td>
          <td>${r.item || ""}</td>
          <td>${r.item_name || ""}</td>
          <td>${r.item_class || ""}</td>
          <td class="num">${r.netsuite_total ?? ""}</td>
          <td class="num">${r.snap_total ?? ""}</td>
          <td class="num" style="font-weight:700;color:${r.difference === 0 ? '#15803d' : '#b91c1c'};">${r.difference ?? ""}</td>
          `;

          tbody.appendChild(tr);
        });
      }

    async function startExport() {
    const snapshotId = document.getElementById("snapshots").value;
    const brand = document.getElementById("brand").value || "";
    const itemClass = document.getElementById("itemClass").value || "";
    const search = document.getElementById("search").value || "";

    const statusEl = document.getElementById("exportStatus");
    statusEl.textContent = "Export: starting…";

    let jobId = null;

    try {
    const res = await fetch(`${API_BASE}/exports`, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Accept": "application/json" },
      body: JSON.stringify({
        snapshotId,
        format: "xlsx",
        filters: { brand, itemClass, search }
      })
    });

    const postText = await res.text();
    console.log("POST /exports status:", res.status, postText);

    if (!res.ok) {
      statusEl.textContent = `Export: POST failed (${res.status})`;
      return;
    }

    const postJson = postText ? JSON.parse(postText) : {};
    jobId = postJson.jobId;

    if (!jobId) {
      statusEl.textContent = "Export: no jobId returned";
      return;
    }

    statusEl.textContent = "Export: queued";
  } catch (e) {
    console.error("Export POST error:", e);
    statusEl.textContent = "Export: POST error — " + (e.message || e);
    return;
  }

    let polls = 0;
    const maxPolls = 60; // 60 * 2s = 2 minutes

    exportPoll = setInterval(async () => {
    polls++;
    if (polls > maxPolls) {
    clearInterval(exportPoll);
    statusEl.textContent = "Export: still queued after 2 minutes (backend worker?)";
    return;
    }

    // ... existing poll logic ...
    }, 2000);

  if (exportPoll) clearInterval(exportPoll);

  exportPoll = setInterval(async () => {
    try {
      const r = await fetch(`${API_BASE}/exports/${jobId}`, {
        headers: { "Accept": "application/json" }
      });

      const text = await r.text();
      console.log("GET /exports/" + jobId + " status:", r.status, text);

      if (!r.ok) {
        statusEl.textContent = `Export: status failed (${r.status})`;
        return;
      }

      const s = text ? JSON.parse(text) : {};
      statusEl.textContent = "Export: " + (s.status || "(no status)");

      if (s.status === "done") {
        clearInterval(exportPoll);
        if (s.downloadUrl) {
          const a = document.createElement("a");
          a.href = s.downloadUrl;
          a.textContent = "Download";
          a.target = "_blank";
          statusEl.appendChild(document.createTextNode(" — "));
          statusEl.appendChild(a);
        } else {
          statusEl.appendChild(document.createTextNode(" (no downloadUrl)"));
        }
      }

      if (s.status === "failed") {
        clearInterval(exportPoll);
        statusEl.textContent = "Export: failed — " + (s.error || "");
      }
    } catch (e) {
      console.error("Export poll error:", e);
      statusEl.textContent = "Export: poll error — " + (e.message || e);
    }
  }, 2000);
}


      document.getElementById("refresh").addEventListener("click", () => { page = 1; loadRows(); });
      document.getElementById("export").addEventListener("click", startExport);
      document.getElementById("snapshots").addEventListener("change", () => { page = 1; loadRows(); });

      (async () => {
        await loadSnapshots();
        await loadRows();
      })();
    </script>
  </body>
</html>