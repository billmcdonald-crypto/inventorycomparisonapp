<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Inventory Comparison</title>
    <style>
      body { font-family: system-ui; padding: 16px; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #ddd; padding: 6px; }
      th { background: #f3f3f3; }
      .row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
      input, select, button { padding: 6px; }
      .num { text-align: center; }
    </style>
  </head>
  <body>
    <h2>Inventory Comparison</h2>

    <div class="row">
      <select id="snapshots"></select>
      <input id="brand" placeholder="Brand" />
      <input id="itemClass" placeholder="Item Class" />
      <input id="search" placeholder="Search item/name" />
      <button id="refresh">Refresh</button>
      <button id="export">Export (async)</button>
      <span id="exportStatus"></span>
    </div>

    <div id="meta"></div>
    <table>
      <thead>
        <tr>
          <th>Brand</th><th>Item</th><th>Item Name</th><th>Class</th>
          <th>NetSuite</th><th>Snap</th><th>Diff</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <script>
      console.log("script loaded ok");

      // Function App base URL (direct)
      const API_BASE = "https://inventorycomparisonapp-asehfcc5fwbwa4cy.westus-01.azurewebsites.net/api";

      let page = 1;
      const pageSize = 100;

      // IMPORTANT: declare exportPoll only once
      let exportPoll = null;

      function formatDatePretty(isoDate) {
        if (!isoDate) return "";
        const d = new Date(isoDate);
        return d.toLocaleDateString("en-US", {
          month: "short",
          day: "2-digit",
          year: "numeric"
        });
      }

      async function loadSnapshots() {
        const res = await fetch(`${API_BASE}/snapshots`, {
          headers: { "Accept": "application/json" }
        });
        if (!res.ok) throw new Error(`snapshots failed (${res.status})`);

        const data = await res.json();
        const sel = document.getElementById("snapshots");
        sel.innerHTML = "";

        if (data && data.length) {
          data.forEach(s => {
            const opt = document.createElement("option");
            opt.value = s.snapshotId;
            opt.textContent = `${formatDatePretty(s.snapshotDate)} (${s.rowCount})`;
            sel.appendChild(opt);
          });
        } else {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No snapshots found";
          sel.appendChild(opt);
        }
      }

      async function loadRows() {
        const snapshotId = document.getElementById("snapshots").value;

        if (!snapshotId) {
          document.getElementById("meta").textContent = "No snapshot selected.";
          document.getElementById("rows").innerHTML = "";
          return;
        }

        const brand = document.getElementById("brand").value || "";
        const itemClass = document.getElementById("itemClass").value || "";
        const search = document.getElementById("search").value || "";

        const qs = new URLSearchParams({
          page: String(page),
          pageSize: String(pageSize),
          brand,
          itemClass,
          search,
          sort: "difference_desc"
        });

        const res = await fetch(`${API_BASE}/snapshots/${snapshotId}/rows?` + qs.toString(), {
          headers: { "Accept": "application/json" }
        });
        if (!res.ok) throw new Error(`rows failed (${res.status})`);

        const data = await res.json();

        document.getElementById("meta").textContent =
          `Total rows: ${data.total} | Page: ${data.page}`;

        const tbody = document.getElementById("rows");
        tbody.innerHTML = "";

        (data.rows || []).forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML =
            `<td>${r.brand || ""}</td>` +
            `<td>${r.item || ""}</td>` +
            `<td>${r.item_name || ""}</td>` +
            `<td>${r.item_class || ""}</td>` +
            `<td class="num">${r.netsuite_total ?? ""}</td>` +
            `<td class="num">${r.snap_total ?? ""}</td>` +
            `<td class="num" style="font-weight:700;color:${r.difference === 0 ? "#15803d" : "#b91c1c"};">${r.difference ?? ""}</td>`;
          tbody.appendChild(tr);
        });
      }

      async function startExport() {
        const snapshotId = document.getElementById("snapshots").value;
        if (!snapshotId) return;

        const brand = document.getElementById("brand").value || "";
        const itemClass = document.getElementById("itemClass").value || "";
        const search = document.getElementById("search").value || "";

        const statusEl = document.getElementById("exportStatus");
        const btn = document.getElementById("export");

        // Stop any existing poll loop (prevents infinite loops)
        if (exportPoll) {
          clearInterval(exportPoll);
          exportPoll = null;
        }

        btn.disabled = true;

        try {
          statusEl.textContent = "Export: starting…";

          const res = await fetch(`${API_BASE}/exports`, {
            method: "POST",
            headers: { "Content-Type": "application/json", "Accept": "application/json" },
            body: JSON.stringify({
              snapshotId,
              format: "xlsx",
              filters: { brand, itemClass, search }
            })
          });

          const text = await res.text();

          if (!res.ok) {
            statusEl.textContent = `Export: POST failed (${res.status})`;
            btn.disabled = false;
            return;
          }

          const data = text ? JSON.parse(text) : {};
          const jobId = data.jobId;

          // If backend returns an immediate downloadUrl, show it.
          if (data.downloadUrl) {
            statusEl.textContent = "Export: done — ";
            const a = document.createElement("a");
            a.href = data.downloadUrl;
            a.textContent = "Download";
            a.target = "_blank";
            statusEl.appendChild(a);
            btn.disabled = false;
            return;
          }

          if (!jobId) {
            statusEl.textContent = "Export: no jobId returned";
            btn.disabled = false;
            return;
          }

          statusEl.textContent = "Export: queued";

          let polls = 0;
          const maxPolls = 60; // ~2 minutes

          exportPoll = setInterval(async () => {
            polls++;

            // timeout
            if (polls > maxPolls) {
              clearInterval(exportPoll);
              exportPoll = null;
              btn.disabled = false;
              statusEl.textContent = "Export timeout";
              return;
            }

            try {
              const r = await fetch(`${API_BASE}/exports/${jobId}`, {
                headers: { "Accept": "application/json" }
              });

              const t = await r.text();
              if (!r.ok) return;

              const s = t ? JSON.parse(t) : {};
              statusEl.textContent = "Export: " + (s.status || "");

              if (s.status === "done") {
                clearInterval(exportPoll);
                exportPoll = null;
                btn.disabled = false;

                statusEl.textContent = "Export: done — ";
                if (s.downloadUrl) {
                  const a = document.createElement("a");
                  a.href = s.downloadUrl;
                  a.textContent = "Download";
                  a.target = "_blank";
                  statusEl.appendChild(a);
                } else {
                  statusEl.appendChild(document.createTextNode("(no downloadUrl)"));
                }
              }

              if (s.status === "failed") {
                clearInterval(exportPoll);
                exportPoll = null;
                btn.disabled = false;
                statusEl.textContent = "Export failed";
              }
            } catch (e) {
              // keep polling; transient errors happen
            }
          }, 2000);

        } catch (e) {
          statusEl.textContent = "Export error";
          btn.disabled = false;
        }
      }

      document.getElementById("refresh").addEventListener("click", () => {
        page = 1;
        loadRows();
      });

      document.getElementById("export").addEventListener("click", startExport);

      document.getElementById("snapshots").addEventListener("change", () => {
        page = 1;
        loadRows();
      });

      (async () => {
        try {
          console.log("Init starting...");
          await loadSnapshots();
          await loadRows();
          console.log("Init finished OK");
        } catch (e) {
          console.error("Init error:", e);
          document.getElementById("meta").textContent =
            "Init failed: " + (e.message || e);
        }
      })();
    </script>
  </body>
</html>